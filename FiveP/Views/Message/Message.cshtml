@using FiveP.Models;
@model List<Message>
@{
    User user = (User)Session["user"];
    if(user == null)
    {
        Response.Redirect("/Center/IndexCenter");
    }
}
<div id="AllQuestionPage">
    <div class="msg_history">
        @foreach (var item in Model)
        {
            if (item.user_id != user.user_id)
            {
                <div class="incoming_msg">
                    <div class="incoming_msg_img"> <img src="https://ptetutorials.com/images/user-profile.png" alt="sunil"> </div>
                    <div class="received_msg">
                        <div class="received_withd_msg">
                            <p>
                                @item.message_content
                            </p>
                            <span class="time_date"> 11:01 AM    |    June 9</span>
                        </div>
                    </div>
                </div>
            }
            else
            {

                <div class="outgoing_msg">
                    <div class="sent_msg">
                        <p>
                            @item.message_content
                        </p>
                        <span class="time_date"> 11:01 AM    |    June 9</span>
                    </div>
                </div>

            }

        }
        <div id="contentMsg@(ViewBag.id)">

        </div>


    </div>
    <div class="type_msg">
        <div class="input_msg_write">
            <form id="formMessage@(ViewBag.id)">
                <input type="hidden" name="user_friend_id" value="@(ViewBag.id)"/>
                <input type="text" id="txtMessage@(ViewBag.id)" name="message_content" class="write_msg" placeholder="Type a message" />
                <button type="button" class="msg_send_btn" id="btnSend@(ViewBag.id)"><i class="far fa-paper-plane"></i></button>
            </form>
            
        </div>
    </div>
</div>

@Scripts.Render("~/bundles/jquery")
<script src="~/Scripts/jquery.signalR-2.4.1.min.js"></script>
<script src="~/signalr/hubs "></script>
<script>
    $(document).ready(function () {
        $("#btnSend@(ViewBag.id)").click(function () {
            var data = $("#formMessage@(ViewBag.id)").serialize();
            $.ajax({
                type: "POST",
                url: "/Message/SaveMessage",
                data: data,
                success: function (response) {
                    window.alert("Sữa thành công");
                    $(this).show();
                }
            })
        })
    })


    $(function () {
        var chat = $.connection.chat;
        console.log(chat);
        loadClient(chat)
        $.connection.hub.start().done(function () {
            $('#btnSend@(ViewBag.id)').click(function () {
                var msg = $('#txtMessage@(ViewBag.id)').val();
                var user_friend_id = $('#user_friend_id').val();
                var id = @user.user_id;
                chat.server.message(msg, id, user_friend_id);
                $('#txtMessage@(ViewBag.id)').val('').focus();
            });
        });

    });
    function loadClient(chat) {
        chat.client.message = function (msg, id, user_friend_id) {
            if (@user.user_id == id && @(ViewBag.id) == user_friend_id) {
                $('#contentMsg@(ViewBag.id)').append(

                    '<div class="outgoing_msg">' + '<div class= "sent_msg"><p>' + msg + '</p><span class="time_date"> 11:01 AM    |    June 9</span></div ></div >'

                    );

            }
            else if (@user.user_id != id && @(ViewBag.id) == user_friend_id) {
                $('#contentMsg@(ViewBag.id)').append(

                    '<div class="incoming_msg"><div class= "incoming_msg_img"> <img src="https://ptetutorials.com/images/user-profile.png" alt="sunil"> </div><div class="received_msg"><div class="received_withd_msg"><p>' + msg + '</p><span class="time_date"> 11:01 AM    |    June 9</span></div></div>'

                    );

            }

        }

    }
</script>
